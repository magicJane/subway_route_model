<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>按起终站点名称获取轨道交通出行路径</title>
    <style>
        #container{width:80%; height:80%;}
    </style>
    <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.4.0&key=02e3de6bd711c45f58321a702dd24468&plugin=AMap.Transfer"></script>
</head>

<body>
    <div id="r_status"></div>
    <div id="r_result"></div>  
    
    <script src="FileSaver.js"></script>
    <script type="text/javascript">
        var output = "";
        var outputFileName = "gaode_stop_pair_route.txt"
    
        var transitOptions = {
            city: '深圳',
            policy:AMap.TransferPolicy.LEAST_TIME
        };

        // var stop_pairs = [[{ keyword: '爱联（地铁站）',city:'深圳' },{ keyword: '安托山（地铁站）',city:'深圳' }],[{ keyword: '爱联（地铁站）',city:'深圳' },{ keyword: '八卦岭（地铁站）',city:'深圳' }]]

        var stop_pairs = ${stop_pairs}     // Python string Template

        var totalCount = stop_pairs.length;
        icount = 0
        var points = stop_pairs[icount]

        var transitSearchComplete = function (status, result){         // result即是对应的公交路线数据信息
            if(status === 'complete' && result.plans && result.plans.length > 0){   
                route_id = 0

                for (var r = 0; r < result.plans.length; r++){
                    var plan = result.plans[r]
                    
                    if (isSubwayRoute(plan)){
                        if (plan){    
                            var lines = new Array()
                            var stops = new Array()
                            for (var i=0; i< plan.segments.length; i++){                    
                                var seg = plan.segments[i]                           

                                if (seg.transit_mode == 'SUBWAY'){        
                                    lines.push(seg.transit.lines[0].name)  

                                    var stop_names = new Array()
                                    stop_names.push(seg.transit.on_station.name)
                                    for (var istop=0; istop<seg.transit.via_stops.length; istop++){
                                        stop_names.push(seg.transit.via_stops[istop].name)
                                    }

                                    stop_names.push(seg.transit.off_station.name)
                                    stops.push(stop_names.join("_"))
                                    
                                }
                            }

                            output += result.start.name + "," + result.end.name + "," + route_id + "," + plan.time.toFixed(1) + "," +
                                plan.cost.toFixed(1) + "," + plan.distance.toFixed(1) + "," + plan.walking_distance.toFixed(1) + "," +
                                lines.join("|") + "," + stops.join("|") + "\n"; 

                            sleep(500);

                        }
                        route_id = route_id + 1
                    }
                }   
            }

            
        icount = icount + 1

        if (icount < totalCount){
            if (icount % 1000 == 0){
                var blob = new Blob([output], {type: "text/plain;charset=utf-8"});
                saveAs(blob, outputFileName);
                output = "";
            }

            points = stop_pairs[icount]
            transit.search(points, transitSearchComplete);

        }
        else{
            var blob = new Blob([output], {type: "text/plain;charset=utf-8"});
            saveAs(blob, outputFileName);
            return ;
        }                

        document.getElementById("r_status").innerHTML = icount + "/" + totalCount;
    
            
            // alert(output);
            // document.getElementById("r_result").innerHTML = output;
        };

        
        // 返回第一条满足条件的plan
        function getPlan(plans) {
            for (var i = 0; i < plans.length; i++){
                var plan = plans[i]
                if (isSubwayRoute(plan)){
                    return plan;
                }
            }

            return null
        }

        function isSubwayRoute(plan){
            var icount = 0
            for (var i=0; i< plan.segments.length; i++){                    
                var seg = plan.segments[i]
                if (seg.transit_mode == 'SUBWAY' || seg.transit_mode == 'WALK'){        
                    icount += 1
                }
            }

            if (icount == plan.segments.length){
                return true
            }
            else{
                return false
            }
        }

    
        //构造公交换乘类
        var transit = new AMap.Transfer(transitOptions);
        //根据起、终点坐标查询公交换乘路线
        transit.search(points, transitSearchComplete);
      
        function sleep(ms) {
            var unixtime_ms = new Date().getTime();
            while(new Date().getTime() < unixtime_ms + ms) {}
        }  
            
        
    </script>
    </body>
    </html>
